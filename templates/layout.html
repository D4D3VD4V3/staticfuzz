<!DOCTYPE html>
<html>
  <head>
      <title>S T A T I C F U Z Z</title>
      <meta charset="UTF-8">
      <meta name=viewport content="width=device-width, initial-scale=1">
      <link rel=stylesheet type=text/css href="{{ url_for('static', filename='style.css') }}">
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    </head>
    <body>
      <header>
        <h1><a href="/">STATICFUZZ</a></h1>
        <p>Here for a blink of an eye.</p>
      </header>
      <main>
	    {% block body %}{% endblock %}
      </main>
      <footer>
        <p>10 anonymous memories, from oldest to newest.</p>

        <p>New memories make me forget old ones.</p>
        
        <p>The <a href="https://github.com/hypatia-software-org/staticfuzz">
        staticfuzz GitHub repository</a> is maintained by
        <a href="http://hypatia.software">Hypatia Software Organization</a>.</p>

        {% if config.BACKGROUND_MP3 %}
          <audio controls>
            <source src="{{ config.BACKGROUND_MP3 }}" type="audio/mpeg">
            Your browser does not support the audio element.
          </audio>
        {% endif %}

        {% if not session.logged_in %}
          <p><a href="{{ url_for('login') }}">god?</a></p>
		{% else %}
          <p><a href="{{ url_for('logout') }}">goodbye</a></p>
		{% endif %}
      </footer>
      <!-- <script src="/sse.js"></script> -->
      <script>
        {% if config.NOTIFICATION_SOUND %}
            var notification_sound = new Audio('{{ config.NOTIFICATION_SOUND}}');
        {% endif %} 

        // notification system
        var Notification = window.Notification || window.mozNotification || window.webkitNotification;

        Notification.requestPermission(function (permission) {
            // .. get permission for showing notifications
            // console.log(permission);
        });

        function showNotification(memory) {
            // display a notification for a new memory
            var instance = new Notification("Staticfuzz Memory #" + memory.id, {
                body: memory.text,
                icon: "http://staticfuzz.com/static/bg-wave.gif"
            });

            instance.onclick = function () {
                // Something to do
            };
            instance.onerror = function () {
                // Something to do
            };
            instance.onshow = function () {
                // Something to do
            };
            instance.onclose = function () {
                // Something to do
            };

            return false;
        }

        // replace chat submit with ajax send
        $('#diamond').removeAttr("method");
        $('#diamond').removeAttr("action");
        $("#diamond").on("submit", function (e) {
            e.preventDefault();
            // Send the data using post
            var posting = $.post("{{ url_for('new_memory') }}", { "text": $("#diamond input").val() } );
            // reset input
            $("#diamond input").val('');
        });

        /* Listen on event source. */

        function listen() {
            var source = new EventSource("/stream/");
            source.onmessage = function(eventdata) {
                console.log(eventdata);
                var memories = JSON.parse(eventdata["data"]);

                $.each(memories, function(index, memory) {
                    // If there are already ten memories in the HTML,
                    // remove the first <li> before we add another!
                    if ($("#memories li").length == 10) {
                        $("#memories li:first-child").remove();
                    }

                    // Notification: pop up message if page isn't focused, optional sound


                    // only popup if the tab doesn't have focus
                    if (! document.hasFocus()) {
                        {% if config.NOTIFICATION_SOUND %}
                        notification_sound.play();
                        {% endif %} 
                        showNotification(memory);
                    }

                    var new_li = jQuery('<li />');
                    new_li.attr('id', memory.id);

                    // If there's a base64 representation of the
                    // url found in memory.text, let's make this
                    // an image memory.
                    if (memory.base64_image) {
                        var link = jQuery('<a />');
                        link.attr('href', memory.text);

                        var image = jQuery('<img />');
                        image.attr('src', "data:image/png;base64," + memory.base64_image);

                        link.append(image);
                        new_li.append(link);
                    } else {  // regular memory
                        new_li.text(memory.text);
                    }

                    $('#memories').append(new_li);

                    {% if session.logged_in %}
                        var god_delete = jQuery("<form />");
                        god_delete.attr("action", "{{ url_for("forget") }}");
                        god_delete.attr("method", "post");

                        var hidden_id = jQuery("<input />");
                        god_delete.attr("type", "hidden");
                        god_delete.attr("value", "");
                        $('#memories').append('<input type="hidden" name="id" value='+memory.id+'>');
                        $('#memories').append('<input type="submit" value="Forget">');
                    {% endif %}

                    $('#memories').append('</li>');
                });
            }
        }

        listen();
      </script>
    </body>
</html>
