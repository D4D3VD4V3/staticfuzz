<!DOCTYPE html>
<html>
  <head>
      <title>S T A T I C F U Z Z</title>
      <meta charset="UTF-8">
      <meta name=viewport content="width=device-width, initial-scale=1">
      <link rel=stylesheet type=text/css href="{{ url_for('static', filename='style.css') }}">
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
      <script>
          {% if config.NOTIFICATION_SOUND %}
              var notification_sound = new Audio('{{ config.NOTIFICATION_SOUND}}');
          {% endif %} 

          // notification system
          var Notification = window.Notification || window.mozNotification || window.webkitNotification;

          Notification.requestPermission(function (permission) {
              // .. get permission for showing notifications
              // console.log(permission);
          });

          function showNotification(memory) {
              // display a notification for a new memory
              var instance = new Notification("Staticfuzz Memory #" + memory.id, {
                  body: memory.memory,
                  icon: "http://staticfuzz.com/static/bg-wave.gif"
              });

              instance.onclick = function () {
                  // Something to do
              };
              instance.onerror = function () {
                  // Something to do
              };
              instance.onshow = function () {
                  // Something to do
              };
              instance.onclose = function () {
                  // Something to do
              };

              return false;
          }

          // flaten memory to list of ids
          function onlyMemoryIds(memories) {
              var ids = [];

              $.each(memories, function( index, memory ) {
                  ids.push(memory.id);
              });

              return ids
          }

          function pollMemories() {
              $.ajax({
                  url: "{{ url_for('list_memories') }}",
                  dataType: 'json',
                  cache: true,
                  timeout: "{{ config.TIMEOUT }}",
                  success: function(list_of_memories) {
                      var new_ids = onlyMemoryIds(list_of_memories);
                      var largest_new_id = Math.max.apply(Math, new_ids);

                      var largest_old_id = parseInt($('#memories').children().last().attr('id'));

                      $.each(list_of_memories, function( index, memory ) {
                          if ( largest_new_id > largest_old_id ) {

                              // make notification sound and display notification
                              // only works after ten memories
                              if ( $("#memories li").length <= 10 && memory.id > largest_old_id )  {
                                  {% if config.NOTIFICATION_SOUND %}
                                  notification_sound.play();
                                  {% endif %} 

                                  if (! document.hasFocus()) {
                                      showNotification(memory);
                                  }
                              }

                              // ...

                              $("#memories li:first-child").remove();

                              var new_li = jQuery('<li />');
                              new_li.attr('id', memory.id);
                              new_li.text(memory.memory)

                              $('#memories').append(new_li);

                              {% if session.logged_in %}
                                  $('#memories').append('<form action={{ url_for("forget") }} method=post>');
                                  $('#memories').append('<input type="hidden" name="id" value='+memory.id+'>');
                                  $('#memories').append('<input type="submit" value="Forget">');
                                  $('#memories').append('</form>');
                              {% endif %}

                              $('#memories').append('</li>');
                          }
                      });
                  },
                  error: function(){
                      $('#memories').empty();
                      $('#memories').append('<li>Error');
                  }
              });
          }         

          setInterval(pollMemories, "{{ config.REFRESH }}");
      </script>
    </head>
    <body>
      <header>
        <h1><a href="/">STATICFUZZ</a></h1>
        <p>Here for a blink of an eye.</p>
      </header>
      <main>
	    {% block body %}{% endblock %}
      </main>
      <footer>
        <p>10 anonymous memories, from oldest to newest.</p>

        <p>New memories make me forget old ones.</p>
        
        <p>The <a href="https://github.com/hypatia-software-org/staticfuzz">
        staticfuzz GitHub repository</a> is maintained by
        <a href="http://hypatia.software">Hypatia Software Organization</a>.</p>

        {% if config.BACKGROUND_MP3 %}
          <audio controls>
            <source src="{{ config.BACKGROUND_MP3 }}" type="audio/mpeg">
            Your browser does not support the audio element.
          </audio>
        {% endif %}

        {% if not session.logged_in %}
          <p><a href="{{ url_for('login') }}">god?</a></p>
		{% else %}
          <p><a href="{{ url_for('logout') }}">goodbye</a></p>
		{% endif %}
      </footer>
    </body>
</html>
